(()=>{var e={};e.id=326,e.ids=[326],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},6356:(e,t,r)=>{"use strict";r.d(t,{t:()=>a});var o=r(89144);let n=new Map;async function s(e){let t=e.trim().replace(/\s+/g," ");if(n.has(t))return console.log("\uD83D\uDCCD Using cached geocode result for:",t),n.get(t);try{console.log("\uD83C\uDF0D Geocoding address:",t);let e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=1&addressdetails=1&countrycodes=se,no,dk,fi,fr,de,gb,es,it&accept-language=en`);if(!e.ok)throw Error(`Geocoding API error: ${e.status}`);let r=await e.json();if(!r||0===r.length)return{error:"NO_RESULTS",message:"No coordinates found for this address"};let o=r[0],s={lat:parseFloat(o.lat),lon:parseFloat(o.lon),display_name:o.display_name,address:o.address?{house_number:o.address.house_number,road:o.address.road,city:o.address.city||o.address.town||o.address.village,postcode:o.address.postcode,country:o.address.country,country_code:o.address.country_code?.toUpperCase()}:void 0};return n.set(t,s),console.log("âœ… Geocoded successfully:",{address:t,lat:s.lat,lon:s.lon,city:s.address?.city}),s}catch(e){return console.error("âŒ Geocoding error:",e),{error:"GEOCODING_FAILED",message:`Failed to geocode address: ${e instanceof Error?e.message:"Unknown error"}`}}}async function a(e,t){let r=await (0,o.w)(),{data:n,error:a}=await r.from("wines").select("id, producer_id").in("id",e.map(e=>e.merchandise.id));if(a||!n)return console.error("Failed to fetch wines for zone matching:",a),{pickupZoneId:null,deliveryZoneId:null,pickupZoneName:null,deliveryZoneName:null};let i=[...new Set(n.map(e=>e.producer_id))],{data:l,error:c}=await r.from("producers").select(`
      id,
      name,
      pickup_zone_id,
      pallet_zones!pickup_zone_id (
        id,
        name,
        zone_type
      )
    `).in("id",i);if(c||!l)return console.error("Failed to fetch producers for zone matching:",c),{pickupZoneId:null,deliveryZoneId:null,pickupZoneName:null,deliveryZoneName:null};let d=l[0]?.pallet_zones,u=d?.id||null,p=d?.name||null,m=null,y=null;if(t.countryCode&&t.city&&t.postcode){let{data:e,error:o}=await r.from("pallet_zones").select("id, name, center_lat, center_lon, radius_km, country_code").eq("zone_type","delivery").or(`country_code.eq.${t.countryCode},country_code.is.null`);if(!o&&e&&e.length>0){let o=function(e){let t=[];return e.street&&t.push(e.street),e.postcode&&t.push(e.postcode),e.city&&t.push(e.city),e.country&&t.push(e.country),t.join(", ")}({street:`${t.postcode} ${t.city}`,postcode:t.postcode,city:t.city,country:"SE"===t.countryCode?"Sweden":void 0}),n=await s(o);if("error"in n)console.warn("âš ï¸ Geocoding failed:",n.message),m=null,y=null;else{let{lat:t,lon:s}=n;if("number"==typeof t&&"number"==typeof s&&!isNaN(t)&&!isNaN(s)&&t>=-90&&t<=90&&s>=-180&&s<=180){console.log("\uD83D\uDCCD Geocoded address:",{address:o,lat:t,lon:s});let n=[];for(let r of e)if(r.center_lat&&r.center_lon&&r.radius_km){let e=function(e,t,r,o){let n=(r-e)*Math.PI/180,s=(o-t)*Math.PI/180,a=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*Math.PI/180)*Math.cos(r*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*6371}(t,s,r.center_lat,r.center_lon);console.log(`ðŸ“ Distance to ${r.name}: ${e.toFixed(2)}km (radius: ${r.radius_km}km)`),e<=r.radius_km&&n.push({id:r.id,name:r.name,centerLat:r.center_lat,centerLon:r.center_lon,radiusKm:r.radius_km})}if(n.length>0){m=n[0].id,console.log("âœ… Found matching delivery zone:",y=n[0].name);let e=[];if(u&&m){let{data:t,error:o}=await r.from("pallets").select(`
                  id,
                  name,
                  bottle_capacity,
                  cost_cents,
                  pickup_zone_id,
                  delivery_zone_id
                `).eq("pickup_zone_id",u).eq("delivery_zone_id",m);if(!o&&t)for(let o of t){let{data:t,error:n}=await r.from("bookings").select("quantity").eq("pallet_id",o.id),s=n?0:t?.reduce((e,t)=>e+t.quantity,0)||0;e.push({id:o.id,name:o.name,currentBottles:s,maxBottles:o.bottle_capacity,remainingBottles:o.bottle_capacity-s,pickupZoneName:p||"",deliveryZoneName:y||"",costCents:o.cost_cents})}}return{pickupZoneId:u,deliveryZoneId:m,pickupZoneName:p,deliveryZoneName:y,availableDeliveryZones:n,pallets:e}}console.log("âŒ No delivery zones match this address"),m=null,y=null}else console.warn("âš ï¸ Invalid coordinates from geocoding:",t,s),m=null,y=null}}}else m=null,y=null;let _=[];if(u&&m){let{data:e,error:t}=await r.from("pallets").select(`
        id,
        name,
        bottle_capacity,
        cost_cents,
        pickup_zone_id,
        delivery_zone_id
      `).eq("pickup_zone_id",u).eq("delivery_zone_id",m);if(!t&&e)for(let t of e){let{data:e,error:o}=await r.from("bookings").select("quantity").eq("pallet_id",t.id),n=o?0:e?.reduce((e,t)=>e+t.quantity,0)||0;_.push({id:t.id,name:t.name,currentBottles:n,maxBottles:t.bottle_capacity,remainingBottles:t.bottle_capacity-n,pickupZoneName:p||"",deliveryZoneName:y||"",costCents:t.cost_cents})}}return{pickupZoneId:u,deliveryZoneId:m,pickupZoneName:p,deliveryZoneName:y,pallets:_}}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},88284:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>y,routeModule:()=>d,serverHooks:()=>m,workAsyncStorage:()=>u,workUnitAsyncStorage:()=>p});var o={};r.r(o),r.d(o,{POST:()=>c});var n=r(96559),s=r(48088),a=r(37719),i=r(32190),l=r(6356);async function c(e){try{let{cartItems:t,deliveryAddress:r}=await e.json();if(!t||!r)return i.NextResponse.json({error:"Missing cart items or delivery address"},{status:400});let o=await (0,l.t)(t,r);return i.NextResponse.json({pickupZoneId:o.pickupZoneId,deliveryZoneId:o.deliveryZoneId,pickupZoneName:o.pickupZoneName,deliveryZoneName:o.deliveryZoneName,availableDeliveryZones:o.availableDeliveryZones||[],pallets:o.pallets||[]})}catch(e){return console.error("Zone determination error:",e),i.NextResponse.json({error:"Failed to determine zones"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/checkout/zones/route",pathname:"/api/checkout/zones",filename:"route",bundlePath:"app/api/checkout/zones/route"},resolvedPagePath:"/Users/axelsamuelson/Downloads/crowdvine_01/app/api/checkout/zones/route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:u,workUnitAsyncStorage:p,serverHooks:m}=d;function y(){return(0,a.patchFetch)({workAsyncStorage:u,workUnitAsyncStorage:p})}},89144:(e,t,r)=>{"use strict";r.d(t,{H:()=>a,w:()=>s});var o=r(44999),n=r(34386);async function s(){let e=await (0,o.UL)(),t="https://abrnvjqwpdkodgrtezeg.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFicm52anF3cGRrb2RncnRlemVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NzQwNjMsImV4cCI6MjA3MjI1MDA2M30.I_i63rAdVM51CKwic2GhNY5z7WKzA8p8OdVVh8-YiGs";if(!t||!r)throw console.error("Missing Supabase environment variables:"),console.error("NEXT_PUBLIC_SUPABASE_URL:",t?"SET":"MISSING"),console.error("NEXT_PUBLIC_SUPABASE_ANON_KEY:",r?"SET":"MISSING"),Error("Supabase environment variables are not configured. Please check your .env.local file.");return(0,n.createServerClient)(t,r,{cookies:{get:t=>e.get(t)?.value,set(e,t,r){console.log(`Cookie ${e} would be set to ${t}`)},remove(e,t){console.log(`Cookie ${e} would be removed`)}}})}async function a(){let e=await s(),{data:{user:t},error:r}=await e.auth.getUser();return r?(console.error("Error getting current user:",r),null):t}},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[4447,3008,4999,4386,580],()=>r(88284));module.exports=o})();