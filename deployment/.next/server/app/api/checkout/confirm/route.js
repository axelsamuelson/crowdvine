(()=>{var e={};e.id=4703,e.ids=[1268,4703],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},6356:(e,t,r)=>{"use strict";r.d(t,{t:()=>n});var o=r(89144);let a=new Map;async function i(e){let t=e.trim().replace(/\s+/g," ");if(a.has(t))return console.log("\uD83D\uDCCD Using cached geocode result for:",t),a.get(t);try{console.log("\uD83C\uDF0D Geocoding address:",t);let e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=1&addressdetails=1&countrycodes=se,no,dk,fi,fr,de,gb,es,it&accept-language=en`);if(!e.ok)throw Error(`Geocoding API error: ${e.status}`);let r=await e.json();if(!r||0===r.length)return{error:"NO_RESULTS",message:"No coordinates found for this address"};let o=r[0],i={lat:parseFloat(o.lat),lon:parseFloat(o.lon),display_name:o.display_name,address:o.address?{house_number:o.address.house_number,road:o.address.road,city:o.address.city||o.address.town||o.address.village,postcode:o.address.postcode,country:o.address.country,country_code:o.address.country_code?.toUpperCase()}:void 0};return a.set(t,i),console.log("✅ Geocoded successfully:",{address:t,lat:i.lat,lon:i.lon,city:i.address?.city}),i}catch(e){return console.error("❌ Geocoding error:",e),{error:"GEOCODING_FAILED",message:`Failed to geocode address: ${e instanceof Error?e.message:"Unknown error"}`}}}async function n(e,t){let r=await (0,o.w)(),{data:a,error:n}=await r.from("wines").select("id, producer_id").in("id",e.map(e=>e.merchandise.id));if(n||!a)return console.error("Failed to fetch wines for zone matching:",n),{pickupZoneId:null,deliveryZoneId:null,pickupZoneName:null,deliveryZoneName:null};let s=[...new Set(a.map(e=>e.producer_id))],{data:c,error:l}=await r.from("producers").select(`
      id,
      name,
      pickup_zone_id,
      pallet_zones!pickup_zone_id (
        id,
        name,
        zone_type
      )
    `).in("id",s);if(l||!c)return console.error("Failed to fetch producers for zone matching:",l),{pickupZoneId:null,deliveryZoneId:null,pickupZoneName:null,deliveryZoneName:null};let d=c[0]?.pallet_zones,u=d?.id||null,m=d?.name||null,p=null,g=null;if(t.countryCode&&t.city&&t.postcode){let{data:e,error:o}=await r.from("pallet_zones").select("id, name, center_lat, center_lon, radius_km, country_code").eq("zone_type","delivery").or(`country_code.eq.${t.countryCode},country_code.is.null`);if(!o&&e&&e.length>0){let o=function(e){let t=[];return e.street&&t.push(e.street),e.postcode&&t.push(e.postcode),e.city&&t.push(e.city),e.country&&t.push(e.country),t.join(", ")}({street:`${t.postcode} ${t.city}`,postcode:t.postcode,city:t.city,country:"SE"===t.countryCode?"Sweden":void 0}),a=await i(o);if("error"in a)console.warn("⚠️ Geocoding failed:",a.message),p=null,g=null;else{let{lat:t,lon:i}=a;if("number"==typeof t&&"number"==typeof i&&!isNaN(t)&&!isNaN(i)&&t>=-90&&t<=90&&i>=-180&&i<=180){console.log("\uD83D\uDCCD Geocoded address:",{address:o,lat:t,lon:i});let a=[];for(let r of e)if(r.center_lat&&r.center_lon&&r.radius_km){let e=function(e,t,r,o){let a=(r-e)*Math.PI/180,i=(o-t)*Math.PI/180,n=Math.sin(a/2)*Math.sin(a/2)+Math.cos(e*Math.PI/180)*Math.cos(r*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n))*6371}(t,i,r.center_lat,r.center_lon);console.log(`📏 Distance to ${r.name}: ${e.toFixed(2)}km (radius: ${r.radius_km}km)`),e<=r.radius_km&&a.push({id:r.id,name:r.name,centerLat:r.center_lat,centerLon:r.center_lon,radiusKm:r.radius_km})}if(a.length>0){p=a[0].id,console.log("✅ Found matching delivery zone:",g=a[0].name);let e=[];if(u&&p){let{data:t,error:o}=await r.from("pallets").select(`
                  id,
                  name,
                  bottle_capacity,
                  cost_cents,
                  pickup_zone_id,
                  delivery_zone_id
                `).eq("pickup_zone_id",u).eq("delivery_zone_id",p);if(!o&&t)for(let o of t){let{data:t,error:a}=await r.from("bookings").select("quantity").eq("pallet_id",o.id),i=a?0:t?.reduce((e,t)=>e+t.quantity,0)||0;e.push({id:o.id,name:o.name,currentBottles:i,maxBottles:o.bottle_capacity,remainingBottles:o.bottle_capacity-i,pickupZoneName:m||"",deliveryZoneName:g||"",costCents:o.cost_cents})}}return{pickupZoneId:u,deliveryZoneId:p,pickupZoneName:m,deliveryZoneName:g,availableDeliveryZones:a,pallets:e}}console.log("❌ No delivery zones match this address"),p=null,g=null}else console.warn("⚠️ Invalid coordinates from geocoding:",t,i),p=null,g=null}}}else p=null,g=null;let _=[];if(u&&p){let{data:e,error:t}=await r.from("pallets").select(`
        id,
        name,
        bottle_capacity,
        cost_cents,
        pickup_zone_id,
        delivery_zone_id
      `).eq("pickup_zone_id",u).eq("delivery_zone_id",p);if(!t&&e)for(let t of e){let{data:e,error:o}=await r.from("bookings").select("quantity").eq("pallet_id",t.id),a=o?0:e?.reduce((e,t)=>e+t.quantity,0)||0;_.push({id:t.id,name:t.name,currentBottles:a,maxBottles:t.bottle_capacity,remainingBottles:t.bottle_capacity-a,pickupZoneName:m||"",deliveryZoneName:g||"",costCents:t.cost_cents})}}return{pickupZoneId:u,deliveryZoneId:p,pickupZoneName:m,deliveryZoneName:g,pallets:_}}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11268:(e,t,r)=>{"use strict";r.d(t,{getSupabaseAdmin:()=>a});var o=r(83008);function a(){let e="https://abrnvjqwpdkodgrtezeg.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Missing Supabase admin credentials");return(0,o.UU)(e,t)}},11997:e=>{"use strict";e.exports=require("punycode")},27069:(e,t,r)=>{"use strict";r.d(t,{m:()=>c});var o=r(89144),a=r(44999),i=r(55511);let n="cv_cart_id";async function s(){let e=await (0,a.UL)(),t=e.get(n)?.value;return t||(t=(0,i.randomUUID)(),e.set(n,t,{httpOnly:!0,sameSite:"lax",path:"/",maxAge:7776e3,secure:!0})),t}class c{static async ensureCart(){let e=await s(),t=await (0,o.w)(),{data:r,error:a}=await t.from("carts").select("id").eq("session_id",e).single();if(!r){let{data:r,error:o}=await t.from("carts").insert({session_id:e}).select("id").single();if(o)throw Error("Failed to create cart");return r.id}return r.id}static async getCart(){try{await s();let e=await (0,o.w)(),{data:t,error:r}=await e.from("cart_items").select(`
          id,
          quantity,
          wines (
            id,
            handle,
            wine_name,
            vintage,
            label_image_path,
            base_price_cents
          )
        `).eq("cart_id",await this.ensureCart()).order("created_at",{ascending:!1});if(r)return console.error("Failed to get cart items:",r),null;if(!t||0===t.length)return{id:await this.ensureCart(),checkoutUrl:"/checkout",cost:{subtotalAmount:{amount:"0.00",currencyCode:"SEK"},totalAmount:{amount:"0.00",currencyCode:"SEK"},totalTaxAmount:{amount:"0.00",currencyCode:"SEK"}},totalQuantity:0,lines:[]};let a=t.map(e=>({id:e.id,quantity:e.quantity,cost:{totalAmount:{amount:(e.wines.base_price_cents*e.quantity/100).toFixed(2),currencyCode:"SEK"}},merchandise:{id:e.wines.id,title:`${e.wines.wine_name} ${e.wines.vintage}`,selectedOptions:[],product:{id:e.wines.id,title:`${e.wines.wine_name} ${e.wines.vintage}`,handle:e.wines.handle,description:"",descriptionHtml:"",productType:"wine",categoryId:"",options:[],variants:[{id:`${e.wines.id}-default`,title:"750 ml",availableForSale:!0,price:{amount:(e.wines.base_price_cents/100).toFixed(2),currencyCode:"SEK"},selectedOptions:[]}],priceRange:{minVariantPrice:{amount:(e.wines.base_price_cents/100).toFixed(2),currencyCode:"SEK"},maxVariantPrice:{amount:(e.wines.base_price_cents/100).toFixed(2),currencyCode:"SEK"}},featuredImage:{id:`${e.wines.id}-img`,url:e.wines.label_image_path,altText:e.wines.wine_name,width:600,height:600},images:[{id:`${e.wines.id}-img`,url:e.wines.label_image_path,altText:e.wines.wine_name,width:600,height:600}],seo:{title:e.wines.wine_name,description:""},tags:[],availableForSale:!0,currencyCode:"SEK",updatedAt:new Date().toISOString(),createdAt:new Date().toISOString()}}})),i=a.reduce((e,t)=>e+parseFloat(t.cost.totalAmount.amount),0);return{id:await this.ensureCart(),checkoutUrl:"/checkout",cost:{subtotalAmount:{amount:i.toFixed(2),currencyCode:"SEK"},totalAmount:{amount:i.toFixed(2),currencyCode:"SEK"},totalTaxAmount:{amount:"0.00",currencyCode:"SEK"}},totalQuantity:a.reduce((e,t)=>e+t.quantity,0),lines:a}}catch(e){return console.error("=== CART SERVICE GET CART ERROR ==="),console.error("CartService.getCart error:",e),console.error("Error stack:",e instanceof Error?e.stack:"No stack trace"),console.error("=== CART SERVICE GET CART ERROR END ==="),null}}static async addItem(e,t=1){try{let r=await this.ensureCart(),a=await (0,o.w)(),{data:i,error:n}=await a.from("cart_items").select("id, quantity").eq("cart_id",r).eq("wine_id",e).single();if(n&&"PGRST116"!==n.code&&console.error("Error checking for existing item:",n),i){let{data:e,error:r}=await a.from("cart_items").update({quantity:i.quantity+t}).eq("id",i.id).select("*").single();if(r)throw console.error("Failed to update cart item:",r),Error("Failed to update cart item")}else{let{data:o,error:i}=await a.from("cart_items").insert({cart_id:r,wine_id:e,quantity:t}).select("*").single();if(i)throw console.error("Failed to add cart item:",i),Error("Failed to add cart item")}return await this.getCart()}catch(e){return console.error("=== CART SERVICE ADD ITEM ERROR ==="),console.error("CartService.addItem error:",e),console.error("Error stack:",e instanceof Error?e.stack:"No stack trace"),console.error("=== CART SERVICE ADD ITEM ERROR END ==="),null}}static async updateItem(e,t){try{let r=await (0,o.w)();if(t<=0){let{error:t}=await r.from("cart_items").delete().eq("id",e);if(t)throw console.error("Failed to remove cart item:",t),Error("Failed to remove cart item")}else{let{error:o}=await r.from("cart_items").update({quantity:t}).eq("id",e);if(o)throw console.error("Failed to update cart item:",o),Error("Failed to update cart item")}return await this.getCart()}catch(e){return console.error("CartService.updateItem error:",e),null}}static async removeItem(e){try{let t=await (0,o.w)(),{error:r}=await t.from("cart_items").delete().eq("id",e);if(r)throw console.error("Failed to remove cart item:",r),Error("Failed to remove cart item");return await this.getCart()}catch(e){return console.error("CartService.removeItem error:",e),null}}static async clearCart(){try{await s();let e=await (0,o.w)(),{error:t}=await e.from("cart_items").delete().eq("cart_id",await this.ensureCart());if(t)throw console.error("Failed to clear cart:",t),Error("Failed to clear cart")}catch(e){throw console.error("CartService.clearCart error:",e),e}}}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},89144:(e,t,r)=>{"use strict";r.d(t,{H:()=>n,w:()=>i});var o=r(44999),a=r(34386);async function i(){let e=await (0,o.UL)(),t="https://abrnvjqwpdkodgrtezeg.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFicm52anF3cGRrb2RncnRlemVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NzQwNjMsImV4cCI6MjA3MjI1MDA2M30.I_i63rAdVM51CKwic2GhNY5z7WKzA8p8OdVVh8-YiGs";if(!t||!r)throw console.error("Missing Supabase environment variables:"),console.error("NEXT_PUBLIC_SUPABASE_URL:",t?"SET":"MISSING"),console.error("NEXT_PUBLIC_SUPABASE_ANON_KEY:",r?"SET":"MISSING"),Error("Supabase environment variables are not configured. Please check your .env.local file.");return(0,a.createServerClient)(t,r,{cookies:{get:t=>e.get(t)?.value,set(e,t,r){console.log(`Cookie ${e} would be set to ${t}`)},remove(e,t){console.log(`Cookie ${e} would be removed`)}}})}async function n(){let e=await i(),{data:{user:t},error:r}=await e.auth.getUser();return r?(console.error("Error getting current user:",r),null):t}},92483:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>p,serverHooks:()=>y,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>_});var o={};r.r(o),r.d(o,{POST:()=>m});var a=r(96559),i=r(48088),n=r(37719),s=r(32190),c=r(27069),l=r(89144),d=r(11268),u=r(6356);async function m(e){try{let t;console.log("=== CHECKOUT CONFIRM START ===");let r=e.headers.get("content-type");if(r?.includes("application/json"))t=await e.json();else{let r=await e.formData();t={address:{fullName:r.get("fullName"),email:r.get("email"),phone:r.get("phone"),street:r.get("street"),postcode:r.get("postcode"),city:r.get("city"),countryCode:r.get("countryCode")},selectedDeliveryZoneId:r.get("selectedDeliveryZoneId"),selectedPalletId:r.get("selectedPalletId"),paymentMethodId:r.get("paymentMethodId")}}console.log("Checkout confirm body:",t);let{address:o}=t;if(!o)return console.error("Missing address in request body"),s.NextResponse.json({error:"Missing address information"},{status:400});let a=await c.m.getCart();if(!a||0===a.totalQuantity)return console.error("Cart is empty"),s.NextResponse.json({error:"Cart is empty"},{status:400});console.log("Processing cart:",a);let i=await (0,l.w)(),n=(0,d.getSupabaseAdmin)(),m=await (0,l.H)();console.log("Current user:",m?.id||"Anonymous"),console.log("Saving customer address:",o);let{data:p,error:g}=await i.from("user_addresses").insert({user_id:m?.id||null,full_name:o.fullName,email:o.email,phone:o.phone,address_street:o.street,address_postcode:o.postcode,address_city:o.city,country_code:o.countryCode}).select().single();if(g)return console.error("Failed to save address:",g),s.NextResponse.json({error:"Failed to save address"},{status:500});console.log("Address saved:",p),console.log("Creating order reservation");let{data:_,error:y}=await n.from("order_reservations").insert({user_id:m?.id||null,cart_id:a.id,address_id:p.id,status:"placed"}).select().single();if(y)return console.error("Failed to create reservation:",y),s.NextResponse.json({error:"Failed to create reservation"},{status:500});console.log("Reservation created:",_),console.log("Creating reservation items");let w=a.lines.map(e=>({reservation_id:_.id,item_id:e.merchandise.id,quantity:e.quantity,price_band:"market"})),{error:h}=await i.from("order_reservation_items").insert(w);if(h)return console.error("Failed to create reservation items:",h),s.NextResponse.json({error:"Failed to create reservation items"},{status:500});console.log("Reservation items created"),console.log("Converting cart items to bookings"),console.log("Determining zones based on cart items and delivery address");let f=await (0,u.t)(a.lines,{postcode:o.postcode,city:o.city,countryCode:o.countryCode});console.log("Zones determined:",f);let v=f.deliveryZoneId;t.selectedDeliveryZoneId&&(v=t.selectedDeliveryZoneId,console.log("Using selected delivery zone:",v));let C=null;if(t.selectedPalletId)C=t.selectedPalletId,console.log("Using selected pallet:",C);else if(f.pickupZoneId&&v){let{data:e,error:t}=await i.from("pallets").select("id").eq("pickup_zone_id",f.pickupZoneId).eq("delivery_zone_id",v).limit(1);!t&&e&&e.length>0&&(C=e[0].id,console.log("Found matching pallet:",C))}let k=a.lines.map(e=>({user_id:m?.id||null,item_id:e.merchandise.id,quantity:e.quantity,band:"market",status:"reserved",pallet_id:C})),{error:I}=await i.from("bookings").insert(k);if(I)return console.error("Failed to create bookings:",I),s.NextResponse.json({error:"Failed to create bookings"},{status:500});if(console.log("Bookings created"),f.pickupZoneId||v){let{error:e}=await i.from("order_reservations").update({pickup_zone_id:f.pickupZoneId,delivery_zone_id:v}).eq("id",_.id);e?console.error("Failed to update reservation with zones:",e):console.log("Reservation updated with zone information")}console.log("Creating reservation tracking record");let{data:E,error:S}=await i.rpc("generate_tracking_code");S&&console.error("Failed to generate tracking code:",S);let R=E?.data||Math.random().toString().slice(2,10),{data:q,error:b}=await i.from("reservation_tracking").insert({reservation_id:_.id,customer_email:o.email,customer_name:o.fullName,tracking_code:R}).select().single();b?console.error("Failed to create tracking record:",b):console.log("Tracking record created:",q),console.log("Clearing cart"),await c.m.clearCart(),console.log("=== CHECKOUT CONFIRM END ===");let F=`/checkout/success?success=true&reservationId=${_.id}&message=${encodeURIComponent("Reservation placed successfully")}`;return s.NextResponse.redirect(new URL(F,e.url))}catch(e){return console.error("=== CHECKOUT CONFIRM ERROR ==="),console.error("Checkout confirm error:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/checkout/confirm/route",pathname:"/api/checkout/confirm",filename:"route",bundlePath:"app/api/checkout/confirm/route"},resolvedPagePath:"/Users/axelsamuelson/Downloads/crowdvine_01/app/api/checkout/confirm/route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:g,workUnitAsyncStorage:_,serverHooks:y}=p;function w(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:_})}},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[4447,3008,4999,4386,580],()=>r(92483));module.exports=o})();