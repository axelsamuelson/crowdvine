(()=>{var e={};e.id=6005,e.ids=[6005],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27069:(e,t,r)=>{"use strict";r.d(t,{m:()=>c});var a=r(89144),i=r(44999),o=r(55511);let n="cv_cart_id";async function s(){let e=await (0,i.UL)(),t=e.get(n)?.value;return t||(t=(0,o.randomUUID)(),e.set(n,t,{httpOnly:!0,sameSite:"lax",path:"/",maxAge:7776e3,secure:!0})),t}class c{static async ensureCart(){let e=await s(),t=await (0,a.w)(),{data:r,error:i}=await t.from("carts").select("id").eq("session_id",e).single();if(!r){let{data:r,error:a}=await t.from("carts").insert({session_id:e}).select("id").single();if(a)throw Error("Failed to create cart");return r.id}return r.id}static async getCart(){try{await s();let e=await (0,a.w)(),{data:t,error:r}=await e.from("cart_items").select(`
          id,
          quantity,
          wines (
            id,
            handle,
            wine_name,
            vintage,
            label_image_path,
            base_price_cents
          )
        `).eq("cart_id",await this.ensureCart()).order("created_at",{ascending:!1});if(r)return console.error("Failed to get cart items:",r),null;if(!t||0===t.length)return{id:await this.ensureCart(),checkoutUrl:"/checkout",cost:{subtotalAmount:{amount:"0.00",currencyCode:"SEK"},totalAmount:{amount:"0.00",currencyCode:"SEK"},totalTaxAmount:{amount:"0.00",currencyCode:"SEK"}},totalQuantity:0,lines:[]};let i=t.map(e=>({id:e.id,quantity:e.quantity,cost:{totalAmount:{amount:(e.wines.base_price_cents*e.quantity/100).toFixed(2),currencyCode:"SEK"}},merchandise:{id:e.wines.id,title:`${e.wines.wine_name} ${e.wines.vintage}`,selectedOptions:[],product:{id:e.wines.id,title:`${e.wines.wine_name} ${e.wines.vintage}`,handle:e.wines.handle,description:"",descriptionHtml:"",productType:"wine",categoryId:"",options:[],variants:[{id:`${e.wines.id}-default`,title:"750 ml",availableForSale:!0,price:{amount:(e.wines.base_price_cents/100).toFixed(2),currencyCode:"SEK"},selectedOptions:[]}],priceRange:{minVariantPrice:{amount:(e.wines.base_price_cents/100).toFixed(2),currencyCode:"SEK"},maxVariantPrice:{amount:(e.wines.base_price_cents/100).toFixed(2),currencyCode:"SEK"}},featuredImage:{id:`${e.wines.id}-img`,url:e.wines.label_image_path,altText:e.wines.wine_name,width:600,height:600},images:[{id:`${e.wines.id}-img`,url:e.wines.label_image_path,altText:e.wines.wine_name,width:600,height:600}],seo:{title:e.wines.wine_name,description:""},tags:[],availableForSale:!0,currencyCode:"SEK",updatedAt:new Date().toISOString(),createdAt:new Date().toISOString()}}})),o=i.reduce((e,t)=>e+parseFloat(t.cost.totalAmount.amount),0);return{id:await this.ensureCart(),checkoutUrl:"/checkout",cost:{subtotalAmount:{amount:o.toFixed(2),currencyCode:"SEK"},totalAmount:{amount:o.toFixed(2),currencyCode:"SEK"},totalTaxAmount:{amount:"0.00",currencyCode:"SEK"}},totalQuantity:i.reduce((e,t)=>e+t.quantity,0),lines:i}}catch(e){return console.error("=== CART SERVICE GET CART ERROR ==="),console.error("CartService.getCart error:",e),console.error("Error stack:",e instanceof Error?e.stack:"No stack trace"),console.error("=== CART SERVICE GET CART ERROR END ==="),null}}static async addItem(e,t=1){try{let r=await this.ensureCart(),i=await (0,a.w)(),{data:o,error:n}=await i.from("cart_items").select("id, quantity").eq("cart_id",r).eq("wine_id",e).single();if(n&&"PGRST116"!==n.code&&console.error("Error checking for existing item:",n),o){let{data:e,error:r}=await i.from("cart_items").update({quantity:o.quantity+t}).eq("id",o.id).select("*").single();if(r)throw console.error("Failed to update cart item:",r),Error("Failed to update cart item")}else{let{data:a,error:o}=await i.from("cart_items").insert({cart_id:r,wine_id:e,quantity:t}).select("*").single();if(o)throw console.error("Failed to add cart item:",o),Error("Failed to add cart item")}return await this.getCart()}catch(e){return console.error("=== CART SERVICE ADD ITEM ERROR ==="),console.error("CartService.addItem error:",e),console.error("Error stack:",e instanceof Error?e.stack:"No stack trace"),console.error("=== CART SERVICE ADD ITEM ERROR END ==="),null}}static async updateItem(e,t){try{let r=await (0,a.w)();if(t<=0){let{error:t}=await r.from("cart_items").delete().eq("id",e);if(t)throw console.error("Failed to remove cart item:",t),Error("Failed to remove cart item")}else{let{error:a}=await r.from("cart_items").update({quantity:t}).eq("id",e);if(a)throw console.error("Failed to update cart item:",a),Error("Failed to update cart item")}return await this.getCart()}catch(e){return console.error("CartService.updateItem error:",e),null}}static async removeItem(e){try{let t=await (0,a.w)(),{error:r}=await t.from("cart_items").delete().eq("id",e);if(r)throw console.error("Failed to remove cart item:",r),Error("Failed to remove cart item");return await this.getCart()}catch(e){return console.error("CartService.removeItem error:",e),null}}static async clearCart(){try{await s();let e=await (0,a.w)(),{error:t}=await e.from("cart_items").delete().eq("cart_id",await this.ensureCart());if(t)throw console.error("Failed to clear cart:",t),Error("Failed to clear cart")}catch(e){throw console.error("CartService.clearCart error:",e),e}}}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},87780:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>p,routeModule:()=>u,serverHooks:()=>w,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{DELETE:()=>l});var i=r(96559),o=r(48088),n=r(37719),s=r(32190),c=r(27069);async function l(e){try{let{searchParams:t}=new URL(e.url),r=t.get("lineId");if(!r)return s.NextResponse.json({error:"Missing lineId"},{status:400});await c.m.removeItem(r);let a=await c.m.getCart();return s.NextResponse.json(a)}catch(e){return console.error("DELETE /api/crowdvine/cart/lines/remove error:",e),s.NextResponse.json({error:"Failed to remove cart item"},{status:500})}}let u=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/crowdvine/cart/lines/remove/route",pathname:"/api/crowdvine/cart/lines/remove",filename:"route",bundlePath:"app/api/crowdvine/cart/lines/remove/route"},resolvedPagePath:"/Users/axelsamuelson/Downloads/crowdvine_01/app/api/crowdvine/cart/lines/remove/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:d,workUnitAsyncStorage:m,serverHooks:w}=u;function p(){return(0,n.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:m})}},89144:(e,t,r)=>{"use strict";r.d(t,{H:()=>n,w:()=>o});var a=r(44999),i=r(34386);async function o(){let e=await (0,a.UL)(),t="https://abrnvjqwpdkodgrtezeg.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFicm52anF3cGRrb2RncnRlemVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NzQwNjMsImV4cCI6MjA3MjI1MDA2M30.I_i63rAdVM51CKwic2GhNY5z7WKzA8p8OdVVh8-YiGs";if(!t||!r)throw console.error("Missing Supabase environment variables:"),console.error("NEXT_PUBLIC_SUPABASE_URL:",t?"SET":"MISSING"),console.error("NEXT_PUBLIC_SUPABASE_ANON_KEY:",r?"SET":"MISSING"),Error("Supabase environment variables are not configured. Please check your .env.local file.");return(0,i.createServerClient)(t,r,{cookies:{get:t=>e.get(t)?.value,set(e,t,r){console.log(`Cookie ${e} would be set to ${t}`)},remove(e,t){console.log(`Cookie ${e} would be removed`)}}})}async function n(){let e=await o(),{data:{user:t},error:r}=await e.auth.getUser();return r?(console.error("Error getting current user:",r),null):t}},96487:()=>{}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4447,3008,4999,4386,580],()=>r(87780));module.exports=a})();