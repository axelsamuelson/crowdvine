(()=>{var e={};e.id=5922,e.ids=[3152,5922],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33152:(e,t,i)=>{"use strict";i.d(t,{getAllWineBoxCalculations:()=>o});var r=i(89144);let n=new Map;async function a(e){let t=n.get(e);if(t&&Date.now()-t.timestamp<3e5)return t.data;let i=await (0,r.w)();try{let{data:t,error:r}=await i.from("wine_boxes").select(`
        id,
        name,
        description,
        handle,
        image_url,
        margin_percentage,
        wine_box_items (
          id,
          wine_id,
          quantity,
          wines (
            id,
            wine_name,
            vintage,
            cost_amount,
            exchange_rate,
            alcohol_tax_cents,
            base_price_cents
          )
        )
      `).eq("id",e).single();if(r||!t)return console.error("Error fetching wine box:",r),null;let a=0,o=0,s=[];for(let e of t.wine_box_items){let t=e.wines,i=t.cost_amount*(t.exchange_rate||1)+(t.alcohol_tax_cents||0)/100,r=i*e.quantity;a+=r,o+=e.quantity,s.push({wineId:t.id,wineName:t.wine_name,vintage:t.vintage,price:i,quantity:e.quantity})}let c=a*(t.margin_percentage/100),l=a+c,u=0;for(let e of t.wine_box_items){let t=e.wines.base_price_cents/100;u+=t*e.quantity}let d=u-l,p=d/u*100,m={wineBoxId:e,name:t.name,description:t.description,handle:t.handle,imageUrl:t.image_url,totalWinePrice:u,marginAmount:c,finalPrice:l,discountAmount:d,discountPercentage:p,bottleCount:o,wines:s};return n.set(e,{data:m,timestamp:Date.now()}),m}catch(e){return console.error("Error calculating wine box price:",e),null}}async function o(){let e="all-wine-boxes",t=n.get(e);if(t&&Date.now()-t.timestamp<3e5)return t.data;let i=await (0,r.w)();try{let{data:t,error:r}=await i.from("wine_boxes").select("id").eq("is_active",!0);if(r||!t)return console.error("Error fetching wine boxes:",r),[];let o=(await Promise.all(t.map(e=>a(e.id)))).filter(e=>null!==e);return n.set(e,{data:o,timestamp:Date.now()}),o}catch(e){return console.error("Error getting all wine box calculations:",e),[]}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55591:e=>{"use strict";e.exports=require("https")},55914:(e,t,i)=>{"use strict";i.r(t),i.d(t,{patchFetch:()=>w,routeModule:()=>d,serverHooks:()=>g,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>m});var r={};i.r(r),i.d(r,{GET:()=>u});var n=i(96559),a=i(48088),o=i(37719),s=i(32190),c=i(89144),l=i(33152);async function u(e,{params:t}){let{searchParams:i}=new URL(e.url),r=i.get("limit")?parseInt(i.get("limit")):200,n=await (0,c.w)(),a=await t;try{if("wine-boxes-collection"===a.id){let e=await (0,l.getAllWineBoxCalculations)();if(0===e.length)return s.NextResponse.json([]);let t=e.map(e=>({id:e.wineBoxId,title:e.name,description:e.description,handle:`wine-box-${e.wineBoxId}`,productType:"wine-box",categoryId:"wine-boxes-collection",priceRange:{minVariantPrice:{amount:e.finalPrice.toFixed(2),currencyCode:"SEK"},maxVariantPrice:{amount:e.finalPrice.toFixed(2),currencyCode:"SEK"}},images:[{url:e.imageUrl||"https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?w=600&h=600&fit=crop",altText:e.name}],variants:[{id:`${e.wineBoxId}-variant`,title:`${e.bottleCount} Bottles`,availableForSale:!0,price:{amount:e.finalPrice.toFixed(2),currencyCode:"SEK"},selectedOptions:[{name:"Size",value:`${e.bottleCount} Bottles`},{name:"Discount",value:`${Math.round(e.discountPercentage)}% off`}]}],options:[{id:"size",name:"Size",values:[`${e.bottleCount} Bottles`]},{id:"discount",name:"Discount",values:[`${Math.round(e.discountPercentage)}% off`]}],tags:[`${e.bottleCount}-bottles`,`${e.discountPercentage}-discount`],discountInfo:{totalWinePrice:e.totalWinePrice,discountAmount:e.discountAmount,discountPercentage:e.discountPercentage,finalPrice:e.finalPrice,wines:e.wines},updatedAt:new Date().toISOString(),createdAt:new Date().toISOString()}));return s.NextResponse.json(t.slice(0,r))}let{data:e,error:t}=await n.from("wines").select(`
        id,
        wine_name,
        vintage,
        grape_varieties,
        color,
        handle,
        base_price_cents,
        label_image_path,
        producer_id
      `).eq("producer_id",a.id).limit(r);if(t)throw t;let i=(e??[]).map(e=>{let t=Array.isArray(e.grape_varieties)?e.grape_varieties:e.grape_varieties?e.grape_varieties.split(",").map(e=>e.trim()):[],i=e.color;return{id:e.id,title:`${e.wine_name} ${e.vintage}`,description:"",descriptionHtml:"",handle:e.handle,productType:"wine",categoryId:e.producer_id,options:[{id:"grape-varieties",name:"Grape Varieties",values:t},{id:"color",name:"Color",values:i?[i]:[]}],variants:[{id:`${e.id}-default`,title:"750 ml",availableForSale:!0,price:{amount:Math.ceil(e.base_price_cents/100).toString(),currencyCode:"SEK"},selectedOptions:[...t.map(e=>({name:"Grape Varieties",value:e})),...i?[{name:"Color",value:i}]:[]]}],priceRange:{minVariantPrice:{amount:Math.ceil(e.base_price_cents/100).toString(),currencyCode:"SEK"},maxVariantPrice:{amount:Math.ceil(e.base_price_cents/100).toString(),currencyCode:"SEK"}},featuredImage:{id:`${e.id}-img`,url:e.label_image_path,altText:e.wine_name,width:600,height:600},images:[{id:`${e.id}-img`,url:e.label_image_path,altText:e.wine_name,width:600,height:600}],seo:{title:e.wine_name,description:""},tags:[...t,...i?[i]:[]],availableForSale:!0,currencyCode:"SEK",updatedAt:new Date().toISOString(),createdAt:new Date().toISOString()}});return s.NextResponse.json(i)}catch(e){return console.error("Error fetching collection products:",e),s.NextResponse.json({error:"Failed to fetch collection products"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/crowdvine/collections/[id]/products/route",pathname:"/api/crowdvine/collections/[id]/products",filename:"route",bundlePath:"app/api/crowdvine/collections/[id]/products/route"},resolvedPagePath:"/Users/axelsamuelson/Downloads/crowdvine_01/app/api/crowdvine/collections/[id]/products/route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:p,workUnitAsyncStorage:m,serverHooks:g}=d;function w(){return(0,o.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:m})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},89144:(e,t,i)=>{"use strict";i.d(t,{H:()=>o,w:()=>a});var r=i(44999),n=i(34386);async function a(){let e=await (0,r.UL)(),t="https://abrnvjqwpdkodgrtezeg.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFicm52anF3cGRrb2RncnRlemVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NzQwNjMsImV4cCI6MjA3MjI1MDA2M30.I_i63rAdVM51CKwic2GhNY5z7WKzA8p8OdVVh8-YiGs";if(!t||!i)throw console.error("Missing Supabase environment variables:"),console.error("NEXT_PUBLIC_SUPABASE_URL:",t?"SET":"MISSING"),console.error("NEXT_PUBLIC_SUPABASE_ANON_KEY:",i?"SET":"MISSING"),Error("Supabase environment variables are not configured. Please check your .env.local file.");return(0,n.createServerClient)(t,i,{cookies:{get:t=>e.get(t)?.value,set(e,t,i){console.log(`Cookie ${e} would be set to ${t}`)},remove(e,t){console.log(`Cookie ${e} would be removed`)}}})}async function o(){let e=await a(),{data:{user:t},error:i}=await e.auth.getUser();return i?(console.error("Error getting current user:",i),null):t}},96487:()=>{}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[4447,3008,4999,4386,580],()=>i(55914));module.exports=r})();